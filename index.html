<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowsta Learn Dashboard</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for professional look --><script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Configure the Inter font and a light background for the clean aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc; /* Very light, clean background */
            overflow-x: hidden; /* Prevent horizontal scroll due to animations */
        }
        /* Custom Tailwind config for the primary brand color and font */
        .logo-font {
            font-weight: 800; 
            letter-spacing: -0.05em;
        }
        /* Progress bar fill transition for smooth animation */
        .progress-bar-fill {
            transition: width 0.7s ease-out; /* Slower, smoother transition */
        }
        .icon-small {
            width: 1rem;
            height: 1rem;
            display: inline-block;
            vertical-align: middle;
        }
        .loading-screen {
            transition: opacity 0.3s ease-in-out;
        }

        /* Keyframes for modal entry animation */
        @keyframes modal-fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animated-content {
            animation: modal-fade-in 0.3s ease-out forwards;
        }

        /* Keyframes for staggered entry animation */
        @keyframes slide-fade-in {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-fade-in {
            animation: slide-fade-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; /* Ease-out quad */
            opacity: 0; /* Initial state before animation */
        }

        /* Override default lucide icon size for consistency */
        i[data-lucide] {
            stroke-width: 2.2; /* Make icons slightly bolder */
        }

        .nav-active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
            padding-bottom: 4px;
        }
        /* Aspect ratio for the video player */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        knowsta: {
                            50: '#f0f3ff',
                            100: '#d9e0ff',
                            500: '#4f46e5', // Primary brand color (Indigo)
                            600: '#4338ca',
                        },
                        // Custom colors for instructor avatars
                        instructor: {
                            blue: '#4f46e5',
                            green: '#22c55e',
                            red: '#ef4444',
                            purple: '#a855f7',
                            yellow: '#eab308',
                            teal: '#14b8a6',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="antialiased">

    <!-- Loading Overlay (Initial state: displayed until auth checks complete) --><div id="loading-overlay" class="loading-screen fixed inset-0 z-[100] bg-white flex items-center justify-center">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-knowsta-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600 font-medium">Loading Knowsta Learn...</p>
        </div>
    </div>
    
    <!-- The main application container --><div id="app" class="min-h-screen opacity-0 transition-opacity duration-300">
        
        <!-- Header: Fixed Top Navigation Bar (Apple/Coursera style) --><header class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <!-- Logo --><a href="#dashboard" onclick="navigateTo('dashboard')" class="flex items-center space-x-2">
                    <span class="text-3xl font-extrabold text-knowsta-500 logo-font">Knowsta</span>
                    <span class="hidden sm:inline text-xl text-gray-500">Learn</span>
                </a>

                <!-- Navigation/Search (Hidden on smaller screens) --><nav class="hidden md:flex flex-1 mx-8 items-center justify-center space-x-8 text-sm font-medium text-gray-600">
                    <a id="nav-dashboard" href="#dashboard" onclick="navigateTo('dashboard')" class="nav-link hover:text-knowsta-500 transition duration-150">My Learning</a>
                    <a id="nav-catalog" href="#catalog" onclick="navigateTo('catalog')" class="nav-link hover:text-knowsta-500 transition duration-150">Catalog</a>
                    <a id="nav-settings" href="#settings" onclick="navigateTo('settings')" class="nav-link hover:text-knowsta-500 transition duration-150">Account Settings</a>
                    <a id="nav-about" href="#about" onclick="navigateTo('about')" class="nav-link hover:text-knowsta-500 transition duration-150">About Knowsta</a>
                </nav>

                <!-- Right side: Auth and Profile (Dynamic) --><div id="auth-section" class="flex items-center space-x-4">
                    <!-- Content will be rendered by JS based on login state --></div>
            </div>
        </header>

        <!-- Main Content Area --><main class="pt-24 p-4 md:p-8 max-w-7xl mx-auto" id="main-content">
            
            <!-- VIEW: Dashboard / My Learning (Default Authenticated View) --><div id="dashboard-view" class="app-view opacity-0 transition-opacity duration-500">
                <!-- Welcome & Key Stats Section (High-level data, clean cards) --><section class="mb-8">
                    <!-- Greeting is now dynamic, updated in JS --><h1 id="welcome-header" class="text-4xl font-extrabold text-gray-800 mb-2">Welcome!</h1>
                    <!-- Subtitle is now dynamic, updated in JS --><p id="welcome-subtitle" class="text-lg text-gray-500 mb-6">Continue your journey and track your progress.</p>
                    
                    <div id="stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Stat Cards will be rendered here by JS --></div>
                </section>

                <!-- My Courses: In Progress Section (Grid of Course Cards) --><section class="mb-12">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="book-open-text" class="w-6 h-6 mr-2 text-knowsta-500"></i>
                        Courses In Progress
                    </h2>
                    <div id="in-progress-courses" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Course cards will be rendered here by JS --></div>
                    <div id="no-progress-message" class="hidden text-center p-8 bg-white rounded-xl border border-gray-100 mt-6">
                        <p class="text-gray-500 text-lg">You haven't started any courses yet. Enroll below to begin!</p>
                    </div>
                </section>

                <!-- Recommended Courses Section --><section class="mb-12">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="lightbulb" class="w-6 h-6 mr-2 text-knowsta-500"></i>
                        Recommended For You
                    </h2>
                    <div id="recommended-courses" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Recommended course cards will be rendered here by JS --></div>
                </section>
            </div>
            
            <!-- VIEW: Account Settings --><div id="settings-view" class="app-view hidden opacity-0 transition-opacity duration-500">
                <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-xl border border-gray-100">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Account Settings</h1>
                    <p class="text-gray-500 mb-8">Manage your profile, preferences, and security settings.</p>

                    <!-- Profile Card -->
                    <div class="mb-8 border-b pb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="user" class="w-5 h-5 mr-2 text-knowsta-500"></i> Profile Information
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Name (Read-only from Supabase Auth) -->
                            <div>
                                <label for="profile-name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input id="profile-name" type="text" disabled class="mt-1 block w-full rounded-lg border border-gray-300 bg-gray-50 px-4 py-2 text-gray-500 cursor-not-allowed text-sm">
                            </div>
                            
                            <!-- Bio (Editable) -->
                            <div>
                                <label for="profile-bio" class="block text-sm font-medium text-gray-700">Bio (Max 150 characters)</label>
                                <textarea id="profile-bio" rows="3" maxlength="150" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm focus:border-knowsta-500 focus:ring-knowsta-500 px-4 py-2 text-sm" placeholder="Tell us a little about your learning goals..."></textarea>
                            </div>

                            <!-- Location (Editable) -->
                            <div>
                                <label for="profile-location" class="block text-sm font-medium text-gray-700">Location</label>
                                <input id="profile-location" type="text" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm focus:border-knowsta-500 focus:ring-knowsta-500 px-4 py-2 text-sm" placeholder="e.g., London, UK">
                            </div>
                            
                            <button onclick="updateUserProfile()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-knowsta-500 hover:bg-knowsta-600 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-knowsta-500 transform hover:-translate-y-0.5 active:translate-y-0.5">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i> Save Profile
                            </button>
                        </div>
                    </div>
                    
                    <!-- Persistence Note -->
                    <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded-lg">
                        <p class="text-sm font-medium">Data Persistence Note:</p>
                        <p class="text-xs">To make these changes permanent across sessions, you must set up and reference a **Supabase Table** (e.g., `user_profiles`) in the `updateUserProfile` function in the JavaScript code below.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: Catalog (Placeholder) --><div id="catalog-view" class="app-view hidden pt-12 text-center opacity-0 transition-opacity duration-500">
                <div class="max-w-xl mx-auto p-10 bg-white rounded-xl shadow-lg border border-gray-100">
                    <i data-lucide="search-check" class="w-12 h-12 text-knowsta-500 mx-auto mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">The Full Catalog is Coming Soon!</h2>
                    <p class="text-gray-500 mb-6">Explore hundreds of courses in tech, business, and art.</p>
                    <button onclick="navigateTo('dashboard')" class="inline-flex items-center justify-center px-6 py-3 text-base font-medium rounded-lg shadow-sm text-white bg-knowsta-500 hover:bg-knowsta-600 transition-colors transform hover:-translate-y-0.5 active:translate-y-0.5">
                        Back to My Learning
                    </button>
                </div>
            </div>
            
            <!-- VIEW: Course Detail (New Placeholder View) --><div id="course-view" class="app-view hidden opacity-0 transition-opacity duration-500">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-xl border border-gray-100">
                    <button onclick="navigateTo('dashboard')" class="text-sm text-knowsta-500 flex items-center mb-6 hover:text-knowsta-600">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Back to Dashboard
                    </button>
                    <h1 id="course-title-detail" class="text-4xl font-extrabold text-gray-800 mb-4">Course Title Placeholder</h1>
                    
                    <!-- Main Content Grid: Video and Lesson List -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Video Player (2/3 width on large screens) -->
                        <div class="lg:col-span-2">
                            <div class="video-container rounded-xl overflow-hidden shadow-lg mb-6">
                                <iframe id="course-video-player" width="560" height="315" src="https://www.youtube.com/embed/dQw4w9WgXcQ?controls=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                            <h2 class="text-2xl font-semibold text-gray-800 mb-3">Course Description</h2>
                            <p class="text-gray-600 mb-6" id="course-details-description">Description placeholder.</p>
                        </div>

                        <!-- Lesson List (1/3 width on large screens) -->
                        <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-100">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="list-check" class="w-5 h-5 mr-2 text-knowsta-500"></i> Lessons
                            </h2>
                            <div id="course-lesson-list" class="space-y-3">
                                <!-- Lessons populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Enrollment/Status Footer -->
                    <div id="course-details-footer" class="mt-8 border-t pt-4 flex justify-between items-center">
                        <div id="course-status"></div>
                        <div id="course-action"></div>
                    </div>

                </div>
            </div>


            <!-- VIEW: About Knowsta Learn --><div id="about-view" class="app-view hidden opacity-0 transition-opacity duration-500">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-xl border border-gray-100">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">About Knowsta Learn</h1>
                    <p class="text-lg text-gray-600 mb-8">
                        Our mission is to democratize high-quality, professional education. We partner with top universities and industry leaders to bring accessible, job-relevant skills to learners worldwide.
                    </p>

                    <div class="grid md:grid-cols-3 gap-6 text-left">
                        <div class="p-4 border rounded-lg">
                            <i data-lucide="target" class="w-6 h-6 text-knowsta-500 mb-3"></i>
                            <h3 class="text-lg font-semibold text-gray-800">Mission-Driven</h3>
                            <p class="text-sm text-gray-600">Empowering individuals through transformative learning experiences that drive career growth.</p>
                        </div>
                        <div class="p-4 border rounded-lg">
                            <i data-lucide="infinity" class="w-6 h-6 text-knowsta-500 mb-3"></i>
                            <h3 class="text-lg font-semibold text-gray-800">Flexible Learning</h3>
                            <p class="text-sm text-gray-600">Learn at your own pace, on your own schedule. Access courses anytime, anywhere, on any device.</p>
                        </div>
                        <div class="p-4 border rounded-lg">
                            <i data-lucide="award" class="w-6 h-6 text-knowsta-500 mb-3"></i>
                            <h3 class="text-lg font-semibold text-gray-800">Certified Excellence</h3>
                            <p class="text-sm text-gray-600">Earn recognized certifications and Specializations that validate your new skills to employers.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logged Out Message --><div id="logged-out-view" class="hidden pt-12 text-center">
                <div class="max-w-xl mx-auto p-10 bg-white rounded-xl shadow-lg border border-gray-100">
                    <i data-lucide="sparkles" class="w-12 h-12 text-knowsta-500 mx-auto mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Unlock Your Learning Journey</h2>
                    <p class="text-gray-500 mb-6">Sign in to access your courses, track progress, and earn certificates.</p>
                    
                    <button onclick="signInWithGoogle()" class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg shadow-sm text-gray-700 bg-white hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-knowsta-500 focus:ring-offset-2 transform hover:-translate-y-0.5 active:translate-y-0.5">
                        <i data-lucide="log-in" class="w-5 h-5 mr-3 text-knowsta-500"></i>
                        Sign In
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- Simple Mock Modal for Actions --><div id="mock-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-10 backdrop-blur-sm" onclick="closeModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform modal-animated-content" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <div id="modal-spinner" class="mr-3 hidden">
                    <svg class="animate-spin h-6 w-6 text-knowsta-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <i id="modal-icon" data-lucide="check-circle" class="w-6 h-6 text-knowsta-500 mr-3"></i>
                <h3 id="modal-title" class="text-lg font-semibold text-gray-800">Action Complete</h3>
            </div>
            <p id="modal-message" class="text-gray-600 mb-6 text-sm"></p>
            <button onclick="closeModal()" class="w-full bg-knowsta-500 text-white py-2 rounded-lg hover:bg-knowsta-600 transition-colors font-medium transform hover:-translate-y-0.5 active:translate-y-0.5">Got It</button>
        </div>
    </div>

    <!-- Hidden element for clipboard copy (Crucial for `document.execCommand`) --><textarea id="clipboard-helper" style="position:absolute; left:-9999px;"></textarea>

    <!-- JavaScript for Supabase Setup, Auth, Mock Data, Rendering, and Interactivity --><script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Supabase Keys
        const SUPABASE_URL = 'https://txexfyeiarmkfxbjsifc.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4ZXhmeWVpYXJta2Z4YmpzaWZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDAxNzYsImV4cCI6MjA3NTUxNjE3Nn0.qAMIETftxjy2GFl_jqtqDucHgOTXOxRrlKQcLs8vwno';
        
        let supabase = null;
        let currentUser = null; // Stores the current Supabase User object
        let isLoading = true;
        let currentView = 'dashboard'; // Default view
        
        // Default (zeroed) profile data structure for a new user
        const DEFAULT_PROFILE_DATA = {
            name: '',
            bio: "Tell us a little about your learning goals...",
            location: "",
            coursesStarted: 0,
            certificatesEarned: 0,
            hoursSpent: 0,
            inProgressCourses: [], // This should be empty for new users
        };

        // Profile data storage (will hold the merged data)
        let userProfileData = { ...DEFAULT_PROFILE_DATA };


        // Colors for instructor avatars
        const instructorAvatarColors = [
            'bg-instructor-blue', 'bg-instructor-green', 'bg-instructor-red', 
            'bg-instructor-purple', 'bg-instructor-yellow', 'bg-instructor-teal'
        ];
        
        // --- Mock Course Data with Lessons and Video URLs ---
        
        // Mock Catalog (Recommended for New Users)
        const mockCourseCatalog = [
            { id: 4, title: "Advanced React Hooks & Context", instructor: "Mia R.", progress: 0, category: "Development", image: 'https://placehold.co/400x200/3b82f6/ffffff?text=React', description: "Deep dive into state management using modern React hooks and the Context API.",
                lessons: [
                    { title: "L1: Intro to UseReducer", url: "https://www.youtube.com/embed/dpwPve9Ym6I" },
                    { title: "L2: Custom Hooks", url: "https://www.youtube.com/embed/rV3d-A5L5gA" },
                    { title: "L3: Context vs Redux", url: "https://www.youtube.com/embed/fD32B8k_iS8" },
                ]
            },
            { id: 5, title: "Introduction to Cloud Computing (GCP)", instructor: "John B.", progress: 0, category: "Cloud", image: 'https://placehold.co/400x200/f59e0b/ffffff?text=Cloud', description: "Learn the fundamentals of Google Cloud Platform, including Compute Engine and Storage.",
                lessons: [
                    { title: "L1: What is the Cloud?", url: "https://www.youtube.com/embed/K95KzV9o3j0" },
                    { title: "L2: Compute Engine Basics", url: "https://www.youtube.com/embed/a8tHhQd-F0Y" },
                ]
            },
            { id: 6, title: "The Art of Negotiation", instructor: "Priya D.", progress: 0, category: "Business", image: 'https://placehold.co/400x200/6366f1/ffffff?text=Business', description: "Master proven strategies to negotiate effectively in both professional and personal scenarios.",
                lessons: [
                    { title: "L1: Win-Win Strategies", url: "https://www.youtube.com/embed/I6l9w1L1Fv8" },
                    { title: "L2: Reading Body Language", url: "https://www.youtube.com/embed/320V-J5p66E" },
                ]
            },
            { id: 7, title: "Creative Writing: Short Story Workshop", instructor: "Ella Z.", progress: 0, category: "Arts", image: 'https://placehold.co/400x200/ec4899/ffffff?text=Writing', description: "A comprehensive workshop covering plot, character development, and narrative voice.",
                 lessons: [
                    { title: "L1: Plot Structure", url: "https://www.youtube.com/embed/uD3l3fL9K-w" },
                    { title: "L2: Character Arc", url: "https://www.youtube.com/embed/pQeM-4z1g0o" },
                ]
            },
        ];
        
        // Mock Progress Data (Simulating a returning user's data)
        const mockReturningUserData = {
            coursesStarted: 7,
            certificatesEarned: 3,
            hoursSpent: 42.5,
            inProgressCourses: [
                { id: 1, title: "Modern Web Design with Tailwind", instructor: "Alex J.", progress: 75, category: "Design", image: 'https://placehold.co/400x200/4f46e5/ffffff?text=Web+Design', description: "Build beautiful, responsive web interfaces using the utility-first framework, Tailwind CSS.", 
                    lessons: [
                        { title: "M1: Setup and Typography", url: "https://www.youtube.com/embed/u_Jk9eFw0tA" },
                        { title: "M2: Responsive Grids", url: "https://www.youtube.com/embed/I0T1Yp1tT1Q" },
                        { title: "M3: Components and State", url: "https://www.youtube.com/embed/P_P_P_P_P_P" }, // Mock incomplete lesson URL
                    ]
                },
                { id: 2, title: "Python for Data Science Fundamentals", instructor: "Dr. L. Khan", progress: 45, category: "Data Science", image: 'https://placehold.co/400x200/10b981/ffffff?text=Python', description: "Foundational course on Python programming tailored for data analysis and visualization.", 
                    lessons: [
                        { title: "M1: Python Setup", url: "https://www.youtube.com/embed/RF_0yT5Y04Q" },
                        { title: "M2: Pandas Dataframes", url: "https://www.youtube.com/embed/cKx-K8yM5xY" },
                        { title: "M3: Intro to Matplotlib", url: "https://www.youtube.com/embed/xR3qg9uN_kM" },
                    ]
                },
                { id: 3, title: "Financial Modeling in Excel", instructor: "Sarah C.", progress: 10, category: "Finance", image: 'https://placehold.co/400x200/ef4444/ffffff?text=Finance', description: "Develop practical skills in creating and analyzing professional financial models.",
                    lessons: [
                        { title: "M1: Financial Statement Review", url: "https://www.youtube.com/embed/T6xY1V4Yy6w" },
                        { title: "M2: Discounted Cash Flow", url: "https://www.youtube.com/embed/x0wV8m8j8Ww" },
                    ]
                },
            ],
        };

        // Consolidated list of all mock courses for easy lookup
        const allMockCourses = [...mockCourseCatalog, ...mockReturningUserData.inProgressCourses].reduce((acc, course) => {
            acc[course.id] = course;
            return acc;
        }, {});


        /**
         * Utility function to get the current Supabase client.
         */
        function getSupabaseClient(url, key) {
            if (supabase && supabase.supabaseUrl === url && supabase.supabaseKey === key) {
                return supabase;
            }
            return createClient(url, key);
        }

        // --- Core Authentication Functions (Supabase) ---

        /**
         * Initializes Supabase client and sets up the authentication listener.
         */
        async function setupSupabase() {
            try {
                supabase = getSupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // Initialize currentView from hash on load
                currentView = window.location.hash.substring(1).split('/')[0] || 'dashboard';

                // 2. Listen for authentication state changes
                supabase.auth.onAuthStateChange((event, session) => {
                    currentUser = session ? session.user : null;
                    isLoading = false;
                    renderApp(); 
                    hideLoadingOverlay();
                    
                    if (event === 'SIGNED_IN') {
                        // On sign-in, try to fetch the profile
                        fetchUserProfile();
                        showModal("Welcome!", "You are now signed in to Knowsta Learn.", "check-circle");
                    } else if (event === 'SIGNED_OUT') {
                         userProfileData = { ...DEFAULT_PROFILE_DATA }; // Reset to default structure
                    }
                });
                
                // 3. Check for initial session immediately
                const { data: { session } = {} } = await supabase.auth.getSession(); 
                currentUser = session ? session.user : null;

                if (currentUser) {
                     await fetchUserProfile(); // Fetch profile if already logged in
                }
                
                if (isLoading) {
                    isLoading = false;
                    renderApp();
                    hideLoadingOverlay();
                }

            } catch (error) {
                console.error("Supabase setup failed:", error);
                isLoading = false;
                renderApp();
                hideLoadingOverlay();
                showModal("Setup Error", "Failed to initialize Supabase. Check the URL and Key configuration.", "x");
            }
        }

        /**
         * Initiates Google Sign-In using Supabase's OAuth method.
         */
        window.signInWithGoogle = async function() {
            try {
                const authClient = getSupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                showModal("Signing In...", "Redirecting to Google for sign-in...", "loader-2", true);

                const { error } = await authClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname, 
                        queryParams: { access_type: 'offline', prompt: 'consent', }
                    },
                });

                if (error) {
                    showModal("Sign In Failed", error.message || "Failed to sign in. Please try again.", "alert-circle");
                    throw error;
                }
            } catch (error) {
                console.error("Google Sign-In failed:", error.message);
                if (!document.getElementById('modal-spinner').classList.contains('hidden')) { 
                    showModal("Sign In Failed", error.message || "Failed to sign in. Please try again.", "alert-circle");
                }
            } finally {
                hideSpinner(); 
            }
        }

        /**
         * Signs out the current user via Supabase.
         */
        window.signOutUser = async function() {
             try {
                const authClient = getSupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                showModal("Signing Out...", "Please wait while we log you out...", "loader-2", true); 
                const { error } = await authClient.auth.signOut();
                if (error) {
                    showModal("Sign Out Error", "Could not sign you out. Please try again.", "alert-circle");
                    throw error;
                }
                showModal("Signed Out", "You have been signed out. Come back soon!", "log-out");
            } catch (error) {
                console.error("Sign-out failed:", error);
                 if (!document.getElementById('mock-modal').classList.contains('flex')) { 
                    showModal("Sign Out Error", "Could not sign you out. Please try again.", "alert-circle");
                }
            } finally {
                hideSpinner();
            }
        }
        
        // --- Supabase Database Mock/Placeholder Functions ---

        /**
         * Mocks fetching the user profile data (bio, location, stats) from a Supabase table.
         * Sets default/zeroed data if no profile is found.
         */
        async function fetchUserProfile() {
            const displayName = currentUser.user_metadata?.full_name || currentUser.email || 'Learner';
            
            // 1. Reset to default and apply name from Auth
            userProfileData = { ...DEFAULT_PROFILE_DATA, name: displayName };
            
            // 2. MOCK DATA CHECK: In a live app, you'd check a Supabase table here.
            
            // MOCK LOGIC: If the first letter of the name is 'N' (New User test) or 'L' (Learner fallback), assume they are new.
            const firstName = displayName.split(' ')[0];
            const isNewUserMock = firstName.toLowerCase().startsWith('n') || firstName.toLowerCase() === 'learner'; 

            if (!isNewUserMock) {
                // If RETURNING, merge mock progress data (simulating DB retrieval)
                userProfileData = {
                    ...userProfileData,
                    ...mockReturningUserData,
                    bio: "I'm interested in advancing my career in data science and product management.",
                    location: "New York, NY",
                };
            }
            // If new user, userProfileData remains the zeroed DEFAULT_PROFILE_DATA (with name filled).

            // Render the settings page with the fetched data
            if (currentView === 'settings') {
                renderSettingsView();
            }
        }

        /**
         * Mocks updating the user profile data (bio, location) in a Supabase table.
         */
        window.updateUserProfile = async function() {
            if (!currentUser) {
                showModal("Error", "You must be signed in to update your profile.", "alert-circle");
                return;
            }
            
            const newBio = document.getElementById('profile-bio').value;
            const newLocation = document.getElementById('profile-location').value;

            // Basic validation
            if (newBio.length > 150) {
                 showModal("Validation Error", "Bio must be 150 characters or less.", "alert-triangle");
                 return;
            }

            userProfileData.bio = newBio;
            userProfileData.location = newLocation;
            
            // --- LIVE SUPABASE LOGIC GOES HERE ---
            showModal("Saving Profile...", "Updating your profile information...", "loader-2", true);

            /* (Supabase update logic example) */

            // --- END LIVE SUPABASE LOGIC ---

            // Mock success and re-render
            setTimeout(() => {
                showModal("Profile Saved!", "Your account settings have been updated.", "check-circle");
                renderApp(); 
            }, 500);
        }

        // --- View Navigation ---

        /**
         * Handles routing between different application views.
         */
        window.navigateTo = function(view, courseId = null) {
            if (!currentUser && view !== 'about') {
                view = 'dashboard';
            }
            
            let hash = view;
            if (view === 'course' && courseId !== null) {
                hash = `course/${courseId}`;
            }
            
            if (currentView !== view) {
                history.pushState(null, null, `#${hash}`);
            }
            currentView = view;
            renderApp();
            
            // Special handling for course view as it needs data loaded
            if (view === 'course' && courseId !== null) {
                 renderCourseDetailView(courseId);
            }
        };
        
        // Handle browser back/forward buttons
        window.onhashchange = function() {
            const hash = window.location.hash.substring(1) || 'dashboard';
            const parts = hash.split('/');
            const newView = parts[0];
            const courseId = parts[1] ? parseInt(parts[1]) : null;
            
            if (currentView !== newView) {
                currentView = newView;
                renderApp();
            }

            if (newView === 'course' && courseId) {
                renderCourseDetailView(courseId);
            }
        };

        /**
         * Populates the course detail view with data for a specific course ID.
         */
        function renderCourseDetailView(courseId) {
            const course = allMockCourses[courseId];
            const videoPlayer = document.getElementById('course-video-player');
            const lessonList = document.getElementById('course-lesson-list');
            const courseStatus = document.getElementById('course-status');
            const courseAction = document.getElementById('course-action');
            
            if (!course) {
                 // Handle course not found
                 document.getElementById('course-title-detail').textContent = 'Course Not Found (ID: ' + courseId + ')';
                 return;
            }
            
            // 1. Course Details
            document.getElementById('course-title-detail').textContent = course.title;
            document.getElementById('course-details-description').textContent = course.description;
            
            // 2. Video Player (Defaults to the first lesson)
            const firstLessonUrl = course.lessons[0].url;
            videoPlayer.src = firstLessonUrl;

            // 3. Lesson List
            lessonList.innerHTML = course.lessons.map((lesson, index) => `
                <div class="flex items-start space-x-3 p-3 rounded-lg border border-gray-100 hover:bg-white transition duration-150 cursor-pointer">
                    <i data-lucide="${index === 0 ? 'play-circle' : 'file-text'}" class="w-5 h-5 flex-shrink-0 mt-0.5 ${index === 0 ? 'text-red-500' : 'text-knowsta-500'}"></i>
                    <div>
                        <p class="font-medium text-gray-800">${lesson.title}</p>
                        <p class="text-xs text-gray-500">${index === 0 ? 'Currently Playing (0:30)' : 'Module video'}</p>
                    </div>
                </div>
            `).join('');
            
            // 4. Footer Status and Action
            const isInProgress = userProfileData.inProgressCourses.some(c => c.id === courseId) || course.progress > 0;
            
            if (isInProgress) {
                courseStatus.innerHTML = `<p class="text-lg font-semibold text-green-600">Enrolled & ${course.progress}% Complete</p>`;
                courseAction.innerHTML = `
                    <button onclick="copyToClipboard('https://knowsta.learn/course/${course.id}', ${course.id})" class="text-sm font-medium text-knowsta-500 hover:text-knowsta-600 transition-colors flex items-center transform hover:-translate-y-0.5 active:translate-y-0.5 mr-4">
                        <i data-lucide="share-2" class="icon-small mr-1"></i> Share
                    </button>
                    <button class="px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-knowsta-500 hover:bg-knowsta-600 transition-colors transform hover:-translate-y-0.5 active:translate-y-0.5">
                        Continue Lesson 1
                    </button>
                `;
            } else {
                 courseStatus.innerHTML = `<p class="text-lg font-semibold text-gray-600">Not Enrolled</p>`;
                 courseAction.innerHTML = `
                    <button onclick="startCourse(${course.id}, '${course.title}')" class="px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-knowsta-500 hover:bg-knowsta-600 transition-colors transform hover:-translate-y-0.5 active:translate-y-0.5">
                        Enroll for Free
                    </button>
                 `;
            }

            // Re-initialize icons
            lucide.createIcons();
        }


        // --- Utility Functions (Modal, Clipboard) ---

        window.closeModal = function() {
            const modal = document.getElementById('mock-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            hideSpinner();
        }

        function showModal(title, message, icon, showSpinner = false) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const modalIcon = document.getElementById('modal-icon');
            const modalSpinner = document.getElementById('modal-spinner');

            if (showSpinner) {
                modalIcon.classList.add('hidden');
                modalSpinner.classList.remove('hidden');
            } else {
                modalIcon.classList.remove('hidden');
                modalSpinner.classList.add('hidden');
                modalIcon.setAttribute('data-lucide', icon || 'check-circle');
            }
            
            if (window.lucide) lucide.createIcons();
            
            document.getElementById('mock-modal').classList.remove('hidden');
            document.getElementById('mock-modal').classList.add('flex');
        }

        function hideSpinner() {
            document.getElementById('modal-spinner').classList.add('hidden');
            document.getElementById('modal-icon').classList.remove('hidden'); 
        }

        window.copyToClipboard = function(textToCopy, courseId) {
            const textarea = document.getElementById('clipboard-helper');
            textarea.value = textToCopy;
            textarea.select();
            
            try {
                document.execCommand('copy');
                showModal("Link Copied!", `The share link for Course ID ${courseId} has been copied to your clipboard. Share your progress!`, "copy");
            } catch (err) {
                console.error('Could not copy text: ', err);
                showModal("Copy Failed", "Could not automatically copy the link. Please try again.", "alert-circle");
            }
        }

        window.startCourse = function(courseId, courseTitle) {
            // In a real app, this would update Supabase, adding the course to the user's profile
            
            // MOCK: Add the course to the inProgressCourses list (if not already there)
            const course = allMockCourses[courseId];
            if (course && !userProfileData.inProgressCourses.some(c => c.id === courseId)) {
                // Clone and add the course to the user's active list with 0% progress
                userProfileData.inProgressCourses.push({ ...course, progress: 0 });
                userProfileData.coursesStarted += 1; // Increment stat
            }
            
            // Navigate to the course page immediately
            navigateTo('course', courseId);
            showModal("Course Enrolled!", `You are now enrolled in "${courseTitle}". Happy learning!`, "send");
        }

        function hideLoadingOverlay() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const app = document.getElementById('app');
            loadingOverlay.style.opacity = '0';
            app.style.opacity = '1';
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
            }, 300);
        }
        
        // --- Rendering Functions ---

        /**
         * Renders the authentication section in the header.
         */
        function renderAuthSection() {
            const authSection = document.getElementById('auth-section');
            let content = '';
            
            if (currentUser) {
                const displayName = userProfileData.name || currentUser.email || 'Learner';
                const initials = (displayName.match(/\b\w/g) || []).join('').toUpperCase() || 'L';
                
                content = `
                    <button class="text-gray-500 hover:text-knowsta-500 p-2 rounded-full transition-colors hidden sm:block" title="Search">
                         <i data-lucide="search" class="w-5 h-5"></i>
                    </button>
                    <!-- User Profile Dropdown Mock --><button onclick="signOutUser()" class="flex items-center space-x-2 bg-knowsta-50 hover:bg-red-500 group rounded-full p-1.5 transition-colors duration-200 transform hover:-translate-y-0.5 active:translate-y-0.5" title="Sign Out">
                        <span class="h-8 w-8 rounded-full bg-knowsta-500 group-hover:bg-red-600 flex items-center justify-center text-white font-semibold text-sm transition-colors">${initials}</span>
                        <span class="hidden sm:inline text-sm font-medium text-gray-700 group-hover:text-white transition-colors">Sign Out</span>
                        <i data-lucide="log-out" class="w-4 h-4 text-gray-600 group-hover:text-white mr-1 hidden sm:inline"></i>
                    </button>
                `;
                authSection.innerHTML = content;

                document.getElementById('welcome-header').textContent = `Hello, ${displayName.split(' ')[0]}!`;

            } else {
                // Logged Out: Show Sign In button
                content = `
                    <button onclick="signInWithGoogle()" class="inline-flex items-center text-sm font-medium text-knowsta-500 hover:bg-knowsta-50 py-2 px-3 rounded-lg transition-colors border border-knowsta-500/20 hover:shadow-md transform hover:-translate-y-0.5 active:translate-y-0.5">
                        <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                        Sign In
                    </button>
                `;
                authSection.innerHTML = content;
            }
        }
        
        /**
         * Renders the settings view with current profile data.
         */
        function renderSettingsView() {
            if (currentUser) {
                // Pre-fill fields with user data
                document.getElementById('profile-name').value = userProfileData.name;
                document.getElementById('profile-bio').value = userProfileData.bio || '';
                document.getElementById('profile-location').value = userProfileData.location || '';
            }
        }

        /**
         * Main function to render the entire application based on auth state and current view.
         */
        function renderApp() {
            renderAuthSection();

            const allViews = document.querySelectorAll('.app-view');
            const loggedOutView = document.getElementById('logged-out-view');
            const subtitleElement = document.getElementById('welcome-subtitle');
            const noProgressMessage = document.getElementById('no-progress-message');
            
            // 1. Handle navigation visibility and active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('nav-active');
                if (link.id === `nav-${currentView}`) {
                    link.classList.add('nav-active');
                }
            });


            if (currentUser) {
                // Logged In: Show selected view and hide logged-out view
                loggedOutView.classList.add('hidden');
                
                // Hide all authenticated views
                allViews.forEach(view => {
                    view.classList.add('hidden');
                    view.classList.add('opacity-0');
                });
                
                // Show the current view
                const viewElement = document.getElementById(`${currentView}-view`) || document.getElementById('dashboard-view');
                viewElement.classList.remove('hidden');
                
                // Trigger fade-in animation
                setTimeout(() => {
                    viewElement.classList.remove('opacity-0');
                }, 10); 

                // 2. Render specific view content
                if (currentView === 'dashboard' || currentView === 'catalog') {
                    
                    const hasProgress = userProfileData.inProgressCourses.length > 0 || userProfileData.coursesStarted > 0;
                    
                    if (hasProgress) {
                        subtitleElement.textContent = "Continue your journey and track your progress.";
                        noProgressMessage.classList.add('hidden');
                    } else {
                        // NEW USER: Zero progress message
                        subtitleElement.textContent = "Your learning adventure starts now. Explore our catalog below!";
                        noProgressMessage.classList.remove('hidden');
                    }
                    
                    // STATS: Use dynamic userProfileData
                    const dashboardStats = [
                        { title: "Courses Started", value: userProfileData.coursesStarted, icon: "graduation-cap", color: "text-blue-500" },
                        { title: "Certificates Earned", value: userProfileData.certificatesEarned, icon: "award", color: "text-green-500" },
                        { title: "Hours Spent (Total)", value: userProfileData.hoursSpent, icon: "clock", color: "text-orange-500" },
                    ];

                    document.getElementById('stats-container').innerHTML = dashboardStats.map(createStatCard).join('');

                    // COURSES IN PROGRESS: Use dynamic userProfileData
                    document.getElementById('in-progress-courses').innerHTML = userProfileData.inProgressCourses.map((course, index) => createCourseCard(course, true, index)).join('');

                    // RECOMMENDED COURSES: Use static mock catalog
                    document.getElementById('recommended-courses').innerHTML = Object.values(allMockCourses)
                        .filter(course => !userProfileData.inProgressCourses.some(c => c.id === course.id)) // Filter out already enrolled
                        .map((course, index) => createCourseCard(course, false, index)).join('');
                
                } else if (currentView === 'settings') {
                    renderSettingsView(); // Render settings page content
                }
                
            } else {
                // Logged Out: Show CTA to sign in
                allViews.forEach(view => view.classList.add('hidden'));
                loggedOutView.classList.remove('hidden');
            }
            
            // Re-initialize Lucide Icons after content is rendered
            lucide.createIcons();
        }


        // --- Course/Stat Card Rendering Functions (Unchanged) ---
        function createStatCard(stat, index) {
            return `
                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-100 flex items-center space-x-4 cursor-pointer hover:shadow-xl hover:scale-[1.02] transition-all duration-300 animate-slide-fade-in" style="animation-delay: ${index * 0.1}s;">
                    <div class="p-3 rounded-full bg-knowsta-50 ${stat.color} bg-opacity-20">
                        <i data-lucide="${stat.icon}" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">${stat.title}</p>
                        <p class="text-3xl font-bold text-gray-800">${stat.value}</p>
                    </div>
                </div>
            `;
        }
        
        function createCourseCard(course, isInProgress, index) {
            const progress = course.progress;
            const progressColor = progress >= 75 ? 'bg-green-500' : progress >= 40 ? 'bg-knowsta-500' : 'bg-orange-500';
            
            const instructorInitials = (course.instructor.match(/\b\w/g) || []).join('');
            const randomColorClass = instructorAvatarColors[Math.floor(Math.random() * instructorAvatarColors.length)];

            const instructorDisplay = `
                <div class="flex items-center space-x-2 text-sm text-gray-500 mb-3 flex-grow">
                    <!-- Instructor Mock Avatar (New Improvement) --><div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-semibold ${randomColorClass} bg-opacity-80 border border-white shadow-sm">
                        ${instructorInitials}
                    </div>
                    <span>${course.instructor}</span>
                </div>
            `;
            
            // Note: The Enroll button now calls navigateTo directly, which triggers startCourse logic
            const buttonAction = isInProgress 
                ? `<button onclick="copyToClipboard('https://knowsta.learn/course/${course.id}', ${course.id})" class="text-sm font-medium text-knowsta-500 hover:text-knowsta-600 transition-colors flex items-center transform hover:-translate-y-0.5 active:translate-y-0.5">
                      <i data-lucide="share-2" class="icon-small mr-1"></i> Share Progress
                   </button>`
                : `<button onclick="event.stopPropagation(); startCourse(${course.id}, '${course.title}')" class="w-full bg-knowsta-500 text-white py-2 rounded-lg hover:bg-knowsta-600 transition-colors font-medium text-sm transform hover:-translate-y-0.5 active:translate-y-0.5">
                      Enroll for Free
                   </button>`;

            const progressDisplay = isInProgress && progress > 0 
                ? `
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-medium text-gray-600">Progress</span>
                            <span class="text-xs font-semibold ${progressColor}">${progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="progress-bar-fill h-2 rounded-full ${progressColor}" style="width: ${progress}%"></div>
                        </div>
                    </div>
                  `
                : `<div class="mt-4 h-9"></div>`; // Placeholder for consistent height

            return `
                <div onclick="navigateTo('course', ${course.id})" class="bg-white shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 rounded-xl overflow-hidden cursor-pointer flex flex-col animate-slide-fade-in" style="animation-delay: ${index * 0.08}s;">
                    <div class="h-40 bg-gray-100 overflow-hidden">
                        <img src="${course.image}" alt="${course.title}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <span class="text-xs font-semibold uppercase text-knowsta-500 mb-1">${course.category}</span>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">${course.title}</h3>
                        ${instructorDisplay}
                        
                        ${progressDisplay}

                        <div class="mt-4 border-t pt-4">
                            ${buttonAction}
                        </div>
                    </div>
                </div>
            `;
        }


        // Initialize the application when the window loads
        window.onload = setupSupabase;

    </script>
</body>
</html>
